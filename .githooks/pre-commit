#!/bin/sh
#
# Pre-commit hook for hamsign
# Runs formatting and basic checks before commit.
#
# Install with: make install-hooks
# Or manually: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo "üîç Running pre-commit checks..."

# Check if Go is available
if ! command -v go >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Go not found - skipping pre-commit checks"
    echo "   Install Go or use 'make docker-ci' to validate"
    exit 0
fi

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "‚úì No Go files staged - skipping checks"
    exit 0
fi

# Run gofmt check
echo "  Checking formatting..."
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>/dev/null || true)
if [ -n "$UNFORMATTED" ]; then
    echo "‚ùå The following files need formatting:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run 'make fmt' to fix formatting"
    exit 1
fi

# Run go vet
echo "  Running go vet..."
go vet ./... || {
    echo "‚ùå go vet found issues"
    exit 1
}

# Run tests on changed packages (quick feedback)
echo "  Running tests..."
go test -short ./... || {
    echo "‚ùå Tests failed"
    exit 1
}

echo "‚úì Pre-commit checks passed"
